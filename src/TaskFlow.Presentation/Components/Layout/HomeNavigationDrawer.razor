@using TaskFlow.Presentation.Components.Pages
@implements IDisposable
@inject IProjectOrchestrator ProjectOrchestrator

<MudDrawerHeader>
    <div class="tf-drawer-brand">
        <MudIcon Icon="@Icons.Material.Filled.Widgets" Size="Size.Medium" />
        <div>
            <div class="tf-drawer-brand-title">TaskFlow</div>
            <div class="tf-drawer-brand-subtitle">Execution First</div>
        </div>
    </div>
</MudDrawerHeader>

<MudNavMenu>
    <MudNavLink Href="" Icon="@Icons.Material.Filled.Home" Match="NavLinkMatch.All">Home</MudNavLink>
</MudNavMenu>

@if (AppState.MyTaskFlowSections.Count > 0)
{
    <MudDivider Class="my-2" />
    <MudText Typo="Typo.caption" Class="tf-drawer-caption">My Task Flow</MudText>
    @foreach (var flowSection in AppState.MyTaskFlowSections)
    {
        var isActive = AppState.SelectedSectionId == flowSection.Id;
        <MudButton FullWidth="true"
                   Variant="@(isActive ? Variant.Filled : Variant.Text)"
                   Color="@(isActive ? Color.Primary : Color.Default)"
                   Class="tf-drawer-button"
                   OnClick="() => AppState.SelectSection(flowSection.Id)">
            @flowSection.Name
        </MudButton>
    }
}

@if (AppState.Projects.Count > 0)
{
    <MudDivider Class="my-2" />
    <MudText Typo="Typo.caption" Class="tf-drawer-caption">Projects</MudText>
    @foreach (var project in AppState.Projects)
    {
        var isActive = AppState.SelectedProjectId == project.Id;
        <MudButton FullWidth="true"
                   Variant="@(isActive ? Variant.Filled : Variant.Text)"
                   Color="@(isActive ? Color.Primary : Color.Default)"
                   Class="tf-drawer-button"
                   OnClick="() => AppState.SelectProject(project.Id)">
            <MudIcon Icon="@ResolveProjectIcon(project.Icon)" Size="Size.Small" Class="mr-2" />
            <span class="tf-project-dot" style="@($"background:{project.Color};")"></span>
            <span class="tf-drawer-project-name">@project.Name</span>
            <MudBadge Class="tf-project-count" Color="Color.Info" Content="@AppState.GetProjectTaskCount(project.Id)" />
        </MudButton>
    }

    <MudStack Row="true" AlignItems="AlignItems.Center" Class="mt-2" Spacing="1">
        <MudTextField @bind-Value="newProjectName"
                      Variant="Variant.Outlined"
                      Margin="Margin.Dense"
                      Immediate="true"
                      Placeholder="New project"
                      Class="tf-drawer-input"
                      OnKeyDown="HandleCreateProjectKeyDown" />
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="CreateProjectAsync">Create</MudButton>
    </MudStack>
}

@code {
    [CascadingParameter]
    public AppState AppState { get; set; } = null!;

    protected override void OnInitialized()
    {
        this.AppState.Changed += OnStateChanged;
    }

    private string newProjectName = string.Empty;

    private async Task CreateProjectAsync()
    {
        if (string.IsNullOrWhiteSpace(this.newProjectName))
        {
            return;
        }

        var created = await this.ProjectOrchestrator.CreateAsync(this.newProjectName, "#2D9CFF", "folder");
        this.newProjectName = string.Empty;

        var updatedProjects = this.AppState.Projects.Concat([created]).OrderBy(project => project.CreatedAt).ToList();
        var updatedCounts = this.AppState.ProjectTaskCounts.ToDictionary(entry => entry.Key, entry => entry.Value);
        updatedCounts[created.Id] = 0;
        this.AppState.SetNavigationData(updatedProjects, this.AppState.MyTaskFlowSections.ToList(), updatedCounts);
        this.AppState.SelectProject(created.Id);
    }

    private async Task HandleCreateProjectKeyDown(KeyboardEventArgs args)
    {
        if (args.Key == "Enter" || args.Key == "NumpadEnter")
        {
            await CreateProjectAsync();
        }
    }

    private string ResolveProjectIcon(string icon)
    {
        return icon?.ToLowerInvariant() switch
        {
            "inbox" => Icons.Material.Filled.Inbox,
            "work" => Icons.Material.Filled.Work,
            "code" => Icons.Material.Filled.Code,
            "flag" => Icons.Material.Filled.Flag,
            _ => Icons.Material.Filled.Folder,
        };
    }

    private void OnStateChanged()
    {
        _ = InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        this.AppState.Changed -= OnStateChanged;
    }
}
