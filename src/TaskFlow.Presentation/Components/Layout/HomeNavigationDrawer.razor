@using TaskFlow.Presentation.Components.Pages
@implements IDisposable
@inject IProjectOrchestrator ProjectOrchestrator
@inject IMyTaskFlowSectionOrchestrator MyTaskFlowSectionOrchestrator
@inject ITaskOrchestrator TaskOrchestrator
@inject NavigationManager NavigationManager
@inject IDialogService DialogService

<MudStack Style="height:100%;" Spacing="0">
    <MudStack Spacing="0">
        @if (AppState.MyTaskFlowSections.Count > 0)
        {
            <MudText Typo="Typo.overline" Class="mt-2 mb-1">My Task Flow</MudText>
            @foreach (var flowSection in AppState.MyTaskFlowSections)
            {
                var isActive = AppState.SelectedSectionId == flowSection.Id;
                <MudButton FullWidth="true"
                           Variant="@(isActive ? Variant.Filled : Variant.Text)"
                           Color="@(isActive ? Color.Primary : Color.Default)"
                           Class="mb-1"
                           Style="justify-content:flex-start; text-transform:none; min-height:42px;"
                           OnClick="() => SelectSection(flowSection.Id)">
                    @flowSection.Name
                </MudButton>
            }
        }

        <MudDivider Class="my-2" />
        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
            <MudText Typo="Typo.overline" Class="mb-0">Projects</MudText>
            <MudIconButton Icon="@Icons.Material.Filled.Add"
                           Size="Size.Small"
                           Color="Color.Primary"
                           aria-label="Create project"
                           title="Create project"
                           OnClick="OpenCreateProjectDialogAsync" />
        </MudStack>
        @foreach (var project in AppState.Projects)
        {
            var isActive = AppState.SelectedProjectId == project.Id;
            <MudButton FullWidth="true"
                       Variant="@(isActive ? Variant.Filled : Variant.Text)"
                       Color="@(isActive ? Color.Primary : Color.Default)"
                       Class="mb-1"
                       Style="justify-content:flex-start; text-transform:none; min-height:42px;"
                       OnClick="() => SelectProject(project.Id)">
                <MudIcon Icon="@ResolveProjectIcon(project.Icon)" Size="Size.Small" Class="mr-2" />
                <MudIcon Icon="@Icons.Material.Filled.Circle" Size="Size.Small" Color="@ResolveProjectColor(project.Color)" Class="mr-2" />
                <MudText Typo="Typo.body2">@project.Name</MudText>
                <MudSpacer />
                <MudBadge Color="Color.Info" Content="@AppState.GetProjectTaskCount(project.Id)" />
            </MudButton>
        }
    </MudStack>

    <MudSpacer />

    <MudStack Spacing="0" Class="pb-1">
        <MudDivider Class="mb-2" />
        <MudNavLink Href="focus-timer" Icon="@Icons.Material.Filled.Timer" Match="NavLinkMatch.Prefix" Class="mb-1" Style="min-height:42px; border-radius:8px;">
            Focus Timer
        </MudNavLink>
        <MudNavLink Href="settings" Icon="@Icons.Material.Filled.Settings" Match="NavLinkMatch.Prefix" Class="mb-1" Style="min-height:42px; border-radius:8px;">
            Settings
        </MudNavLink>
        <MudNavLink Href="about" Icon="@Icons.Material.Filled.Info" Match="NavLinkMatch.Prefix" Class="mb-1" Style="min-height:42px; border-radius:8px;">
            About
        </MudNavLink>
    </MudStack>
</MudStack>

@code {
    [CascadingParameter]
    public AppState AppState { get; set; } = null!;

    protected override async Task OnInitializedAsync()
    {
        this.AppState.Changed += OnStateChanged;
        await EnsureNavigationLoadedAsync();
    }

    private void SelectSection(Guid sectionId)
    {
        this.AppState.SelectSection(sectionId);
        if (!this.NavigationManager.Uri.EndsWith("/", StringComparison.OrdinalIgnoreCase))
        {
            this.NavigationManager.NavigateTo("/");
        }
    }

    private void SelectProject(Guid projectId)
    {
        this.AppState.SelectProject(projectId);
        if (!this.NavigationManager.Uri.EndsWith("/", StringComparison.OrdinalIgnoreCase))
        {
            this.NavigationManager.NavigateTo("/");
        }
    }

    private async Task OpenCreateProjectDialogAsync()
    {
        var dialog = await this.DialogService.ShowAsync<ProjectCreateDialog>("New Project", new DialogOptions
        {
            CloseOnEscapeKey = true,
            MaxWidth = MaxWidth.ExtraSmall,
            FullWidth = true,
        });

        var result = await dialog.Result;
        if (result.Canceled || result.Data is not string title || string.IsNullOrWhiteSpace(title))
        {
            return;
        }

        await CreateProjectAsync(title.Trim());
    }

    private async Task CreateProjectAsync(string projectName)
    {
        var created = await this.ProjectOrchestrator.CreateAsync(projectName, ResolveProjectColorValue(Color.Primary), "folder");

        var updatedProjects = this.AppState.Projects.Concat([created]).OrderBy(project => project.CreatedAt).ToList();
        var updatedCounts = this.AppState.ProjectTaskCounts.ToDictionary(entry => entry.Key, entry => entry.Value);
        updatedCounts[created.Id] = 0;
        this.AppState.SetNavigationData(updatedProjects, this.AppState.MyTaskFlowSections.ToList(), updatedCounts);
        this.AppState.SelectProject(created.Id);
    }

    private async Task EnsureNavigationLoadedAsync()
    {
        if (this.AppState.Projects.Count > 0 || this.AppState.MyTaskFlowSections.Count > 0)
        {
            return;
        }

        var projects = (await this.ProjectOrchestrator.GetAllAsync()).OrderBy(project => project.CreatedAt).ToList();
        var sections = await this.MyTaskFlowSectionOrchestrator.GetAllAsync();
        var counts = await BuildProjectTaskCountsAsync(projects);
        this.AppState.SetNavigationData(projects, sections, counts);
    }

    private async Task<Dictionary<Guid, int>> BuildProjectTaskCountsAsync(IReadOnlyList<TaskFlow.Domain.Project> projects)
    {
        var counts = new Dictionary<Guid, int>();
        foreach (var project in projects)
        {
            var projectTasks = await this.TaskOrchestrator.GetByProjectIdAsync(project.Id);
            var count = projectTasks.Count(task => !task.IsCompleted);
            foreach (var task in projectTasks)
            {
                var subtasks = await this.TaskOrchestrator.GetSubTasksAsync(task.Id);
                count += subtasks.Count(subTask => !subTask.IsCompleted);
            }

            counts[project.Id] = count;
        }

        return counts;
    }

    private string ResolveProjectIcon(string icon)
    {
        return icon?.ToLowerInvariant() switch
        {
            "inbox" => Icons.Material.Filled.Inbox,
            "work" => Icons.Material.Filled.Work,
            "code" => Icons.Material.Filled.Code,
            "flag" => Icons.Material.Filled.Flag,
            _ => Icons.Material.Filled.Folder,
        };
    }

    private static Color ResolveProjectColor(string color)
    {
        return color?.ToLowerInvariant() switch
        {
            "primary" or "#2d9cff" => Color.Primary,
            "success" or "#10b981" or "#30c76a" => Color.Success,
            "warning" or "#f57c00" or "#f2b01e" or "#f97316" => Color.Warning,
            "error" or "#ff6b6b" or "#ef4b6c" => Color.Error,
            "info" or "#14b8a6" => Color.Info,
            "secondary" or "#9b5de5" => Color.Secondary,
            "dark" or "#64748b" => Color.Dark,
            _ => Color.Primary,
        };
    }

    private static string ResolveProjectColorValue(Color color)
    {
        return color switch
        {
            Color.Success => "success",
            Color.Warning => "warning",
            Color.Error => "error",
            Color.Info => "info",
            Color.Secondary => "secondary",
            Color.Dark => "dark",
            _ => "primary",
        };
    }

    private void OnStateChanged()
    {
        _ = InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        this.AppState.Changed -= OnStateChanged;
    }
}
