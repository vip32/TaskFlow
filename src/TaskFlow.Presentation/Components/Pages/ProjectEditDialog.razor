@using TaskFlow.Application
@using TaskFlow.Domain
@inject IProjectOrchestrator ProjectOrchestrator

<MudDialog>
    <DialogContent>
        <MudText Typo="Typo.h6" Class="mb-2">Edit Project</MudText>
        <form @onsubmit="HandleSubmitAsync">
            <MudTextField T="string"
                          Value="projectName"
                          ValueChanged="OnNameChangedAsync"
                          Label="Project name"
                          Variant="Variant.Outlined"
                          Margin="Margin.Dense" />

            <MudSelect T="string"
                       Value="projectColor"
                       ValueChanged="OnColorChangedAsync"
                       Label="Color"
                       Variant="Variant.Outlined"
                       Dense="true">
                @foreach (var option in colorOptions)
                {
                    <MudSelectItem Value="@option.Value">
                        <span class="tf-color-option">
                            <MudIcon Icon="@Icons.Material.Filled.Circle" Size="Size.Small" Color="@option.Color" Class="mr-1" />
                            <span>@option.Name</span>
                        </span>
                    </MudSelectItem>
                }
            </MudSelect>

            <MudSelect T="string"
                       Value="projectIcon"
                       ValueChanged="OnIconChangedAsync"
                       Label="Icon"
                       Variant="Variant.Outlined"
                       Dense="true">
                <MudSelectItem Value="@("folder")">Folder</MudSelectItem>
                <MudSelectItem Value="@("inbox")">Inbox</MudSelectItem>
                <MudSelectItem Value="@("work")">Work</MudSelectItem>
                <MudSelectItem Value="@("code")">Code</MudSelectItem>
                <MudSelectItem Value="@("flag")">Flag</MudSelectItem>
            </MudSelect>

            <button type="submit" class="tf-hidden-submit" aria-hidden="true" tabindex="-1"></button>
        </form>
    </DialogContent>

    <DialogActions>
        <MudTooltip Text="Delete project">
            <MudIconButton Icon="@Icons.Material.Filled.Delete"
                           Color="Color.Error"
                           aria-label="Delete project"
                           title="Delete project"
                           OnClick="DeleteProjectAsync" />
        </MudTooltip>
        <MudSpacer />
        <MudButton Variant="Variant.Outlined" OnClick="Close">Cancel</MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="Close">OK</MudButton>
    </DialogActions>
</MudDialog>

@code {
    private readonly (string Value, string Name, Color Color)[] colorOptions =
    [
        ("primary", "Primary", Color.Primary),
        ("success", "Success", Color.Success),
        ("warning", "Warning", Color.Warning),
        ("error", "Error", Color.Error),
        ("info", "Info", Color.Info),
        ("secondary", "Secondary", Color.Secondary),
        ("dark", "Dark", Color.Dark),
    ];

    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; } = null!;

    [Parameter]
    public Guid ProjectId { get; set; }

    [Parameter]
    public string InitialName { get; set; } = string.Empty;

    [Parameter]
    public string InitialColor { get; set; } = "primary";

    [Parameter]
    public string InitialIcon { get; set; } = "folder";

    [Parameter, EditorRequired]
    public EventCallback<Guid> OnDeleteProject { get; set; }

    private string projectName = string.Empty;
    private string projectColor = "primary";
    private string projectIcon = "folder";

    protected override void OnParametersSet()
    {
        this.projectName = this.InitialName;
        this.projectColor = NormalizeProjectColor(this.InitialColor);
        this.projectIcon = this.InitialIcon;
    }

    private async System.Threading.Tasks.Task OnNameChangedAsync(string value)
    {
        this.projectName = value;
        await this.ProjectOrchestrator.UpdateNameAsync(this.ProjectId, value);
    }

    private async System.Threading.Tasks.Task OnColorChangedAsync(string value)
    {
        this.projectColor = NormalizeProjectColor(value);
        await this.ProjectOrchestrator.UpdateVisualsAsync(this.ProjectId, this.projectColor, this.projectIcon);
    }

    private async System.Threading.Tasks.Task OnIconChangedAsync(string value)
    {
        this.projectIcon = value;
        await this.ProjectOrchestrator.UpdateVisualsAsync(this.ProjectId, this.projectColor, value);
    }

    private System.Threading.Tasks.Task HandleSubmitAsync()
    {
        this.MudDialog.Close(DialogResult.Ok(true));
        return System.Threading.Tasks.Task.CompletedTask;
    }

    private void Close()
    {
        this.MudDialog.Close(DialogResult.Ok(true));
    }

    private async System.Threading.Tasks.Task DeleteProjectAsync()
    {
        await this.OnDeleteProject.InvokeAsync(this.ProjectId);
        this.MudDialog.Close(DialogResult.Ok(true));
    }

    private static string NormalizeProjectColor(string value)
    {
        return value?.ToLowerInvariant() switch
        {
            "#2d9cff" or "primary" => "primary",
            "#10b981" or "#30c76a" or "success" => "success",
            "#f57c00" or "#f2b01e" or "#f97316" or "warning" => "warning",
            "#ff6b6b" or "#ef4b6c" or "error" => "error",
            "#14b8a6" or "info" => "info",
            "#9b5de5" or "secondary" => "secondary",
            "#64748b" or "dark" => "dark",
            _ => "primary",
        };
    }
}
