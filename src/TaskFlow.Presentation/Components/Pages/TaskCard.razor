@using TaskFlow.Domain
@using DomainTaskStatus = TaskFlow.Domain.TaskStatus

<MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
    <MudTooltip Text="Complete task">
        <MudCheckBox T="bool" Value="Item.IsCompleted" ValueChanged="OnCompleteChangedAsync" />
    </MudTooltip>

    <MudTooltip Text="Toggle focus pin">
        <MudIconButton Icon="@(Item.IsFocused ? Icons.Material.Filled.PushPin : Icons.Material.Outlined.PushPin)"
                       Color="@(Item.IsFocused ? Color.Success : Color.Default)"
                       OnClick="OnToggleFocusAsync" />
    </MudTooltip>

    <MudTextField T="string"
                  Value="Item.Title"
                  ValueChanged="OnTitleChangedAsync"
                  Variant="Variant.Text"
                  Immediate="true"
                  Class="@(Item.IsCompleted ? "tf-task-title tf-task-title-done" : "tf-task-title")" />

    <MudSelect T="TaskPriority" Value="Item.Priority" ValueChanged="OnPriorityChangedAsync" Dense="true" Variant="Variant.Text">
        <MudSelectItem Value="@TaskPriority.High">High</MudSelectItem>
        <MudSelectItem Value="@TaskPriority.Medium">Medium</MudSelectItem>
        <MudSelectItem Value="@TaskPriority.Low">Low</MudSelectItem>
    </MudSelect>

    <MudSelect T="DomainTaskStatus" Value="Item.Status" ValueChanged="OnStatusChangedAsync" Dense="true" Variant="Variant.Text">
        @foreach (var status in BoardStatuses)
        {
            <MudSelectItem Value="@status">@status.ToString()</MudSelectItem>
        }
    </MudSelect>

    <MudTooltip Text="Mark for today">
        <MudIconButton Icon="@Icons.Material.Filled.Today" Color="@(Item.IsMarkedForToday ? Color.Warning : Color.Default)" OnClick="OnToggleTodayAsync" />
    </MudTooltip>

    <MudTooltip Text="Duplicate task">
        <MudIconButton Icon="@Icons.Material.Filled.ContentCopy" OnClick="OnDuplicateAsync" />
    </MudTooltip>

    <MudTooltip Text="Move task">
        <MudIconButton Icon="@Icons.Material.Filled.DriveFileMove" OnClick="OnMoveRequestedAsync" />
    </MudTooltip>

    <MudTooltip Text="Delete task">
        <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="OnDeleteAsync" />
    </MudTooltip>
</MudStack>

<MudTextField T="string"
              Value="Item.Note"
              Placeholder="Optional note"
              Variant="Variant.Text"
              Lines="2"
              Immediate="true"
              ValueChanged="OnNoteChangedAsync" />

<div class="tf-task-meta">
    <span class="tf-task-meta-dot" style="@($"background:{PriorityColor(Item.Priority)}")"></span>
    <span>@Item.Priority.ToString()</span>
    <span>@($"Created {RelativeTime(Item.CreatedAt)}")</span>
    @if (Item.CompletedAt.HasValue)
    {
        <span>@($"Completed {RelativeTime(Item.CompletedAt.Value)}")</span>
    }
</div>

@code {
    [Parameter, EditorRequired]
    public TaskFlow.Domain.Task Item { get; set; } = null!;

    [Parameter]
    public IReadOnlyList<DomainTaskStatus> BoardStatuses { get; set; } = [];

    [Parameter]
    public EventCallback OnToggleComplete { get; set; }

    [Parameter]
    public EventCallback OnToggleFocus { get; set; }

    [Parameter]
    public EventCallback<string> OnUpdateTitle { get; set; }

    [Parameter]
    public EventCallback<string> OnUpdateNote { get; set; }

    [Parameter]
    public EventCallback<TaskPriority> OnUpdatePriority { get; set; }

    [Parameter]
    public EventCallback<DomainTaskStatus> OnUpdateStatus { get; set; }

    [Parameter]
    public EventCallback OnToggleToday { get; set; }

    [Parameter]
    public EventCallback OnDuplicate { get; set; }

    [Parameter]
    public EventCallback OnDelete { get; set; }

    [Parameter]
    public EventCallback OnRequestMove { get; set; }

    private static string PriorityColor(TaskPriority priority)
    {
        return priority switch
        {
            TaskPriority.High => "#FF6B6B",
            TaskPriority.Medium => "#F57C00",
            _ => "#10B981",
        };
    }

    private static string RelativeTime(DateTime value)
    {
        var delta = DateTime.UtcNow - value;
        if (delta.TotalMinutes < 1)
        {
            return "just now";
        }

        if (delta.TotalHours < 1)
        {
            return $"{Math.Floor(delta.TotalMinutes)}m ago";
        }

        if (delta.TotalDays < 1)
        {
            return $"{Math.Floor(delta.TotalHours)}h ago";
        }

        return $"{Math.Floor(delta.TotalDays)}d ago";
    }

    private System.Threading.Tasks.Task OnCompleteChangedAsync(bool _)
    {
        return this.OnToggleComplete.InvokeAsync();
    }

    private System.Threading.Tasks.Task OnToggleFocusAsync(MouseEventArgs _)
    {
        return this.OnToggleFocus.InvokeAsync();
    }

    private System.Threading.Tasks.Task OnTitleChangedAsync(string value)
    {
        return this.OnUpdateTitle.InvokeAsync(value);
    }

    private System.Threading.Tasks.Task OnNoteChangedAsync(string value)
    {
        return this.OnUpdateNote.InvokeAsync(value);
    }

    private System.Threading.Tasks.Task OnPriorityChangedAsync(TaskPriority value)
    {
        return this.OnUpdatePriority.InvokeAsync(value);
    }

    private System.Threading.Tasks.Task OnStatusChangedAsync(DomainTaskStatus value)
    {
        return this.OnUpdateStatus.InvokeAsync(value);
    }

    private System.Threading.Tasks.Task OnToggleTodayAsync(MouseEventArgs _)
    {
        return this.OnToggleToday.InvokeAsync();
    }

    private System.Threading.Tasks.Task OnDuplicateAsync(MouseEventArgs _)
    {
        return this.OnDuplicate.InvokeAsync();
    }

    private System.Threading.Tasks.Task OnMoveRequestedAsync(MouseEventArgs _)
    {
        return this.OnRequestMove.InvokeAsync();
    }

    private System.Threading.Tasks.Task OnDeleteAsync(MouseEventArgs _)
    {
        return this.OnDelete.InvokeAsync();
    }
}
