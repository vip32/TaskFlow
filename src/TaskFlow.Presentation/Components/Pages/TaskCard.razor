@using TaskFlow.Domain
@using DomainTaskStatus = TaskFlow.Domain.TaskStatus

<div @onclick:stopPropagation="true">
<MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
    <MudTooltip Text="Complete task">
        <MudCheckBox T="bool" Value="isCompleted" ValueChanged="OnCompleteChangedAsync" />
    </MudTooltip>

    <MudTooltip Text="Toggle focus pin">
        <MudIconButton Icon="@(isFocused ? Icons.Material.Filled.PushPin : Icons.Material.Outlined.PushPin)"
                       Color="@(isFocused ? Color.Success : Color.Default)"
                       aria-label="Toggle focus pin"
                       Class="@(isFocused ? "tf-toggle-active" : string.Empty)"
                       title="Toggle focus pin"
                       OnClick="OnToggleFocusAsync" />
    </MudTooltip>

    @if (AllowImportant)
    {
        <MudTooltip Text="Toggle important">
            <MudIconButton Icon="@(isImportant ? Icons.Material.Filled.Star : Icons.Material.Outlined.StarBorder)"
                           Color="@(isImportant ? Color.Warning : Color.Default)"
                           aria-label="Toggle important"
                           Class="@(isImportant ? "tf-toggle-active" : string.Empty)"
                           title="Toggle important"
                           OnClick="OnToggleImportantAsync" />
        </MudTooltip>
    }

    <MudTextField T="string"
                  Value="Item.Title"
                  ValueChanged="OnTitleChangedAsync"
                  Variant="Variant.Text"
                  Immediate="true"
                  Class="@(isCompleted ? "tf-task-title-done" : string.Empty)"
                  Style="min-width: 200px;" />

    <MudSelect T="TaskPriority" Value="Item.Priority" ValueChanged="OnPriorityChangedAsync" Dense="true" Variant="Variant.Text">
        <MudSelectItem Value="@TaskPriority.High">High</MudSelectItem>
        <MudSelectItem Value="@TaskPriority.Medium">Medium</MudSelectItem>
        <MudSelectItem Value="@TaskPriority.Low">Low</MudSelectItem>
    </MudSelect>

    <MudSelect T="DomainTaskStatus" Value="Item.Status" ValueChanged="OnStatusChangedAsync" Dense="true" Variant="Variant.Text">
        @foreach (var status in BoardStatuses)
        {
            <MudSelectItem Value="@status">@status.ToString()</MudSelectItem>
        }
    </MudSelect>

    <MudTooltip Text="Mark for today">
        <MudIconButton Icon="@Icons.Material.Filled.Today" Color="@(Item.IsMarkedForToday ? Color.Warning : Color.Default)" aria-label="Mark for today" title="Mark for today" OnClick="OnToggleTodayAsync" />
    </MudTooltip>

    <MudTooltip Text="Duplicate task">
        <MudIconButton Icon="@Icons.Material.Filled.ContentCopy" aria-label="Duplicate task" title="Duplicate task" OnClick="OnDuplicateAsync" />
    </MudTooltip>

    <MudTooltip Text="Move task">
        <MudIconButton Icon="@Icons.Material.Filled.DriveFileMove" aria-label="Move task" title="Move task" OnClick="OnMoveRequestedAsync" />
    </MudTooltip>

    @if (ShowDeleteAction)
    {
        <MudTooltip Text="Delete task">
            <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" aria-label="Delete task" title="Delete task" OnClick="OnDeleteAsync" />
        </MudTooltip>
    }
</MudStack>

<MudTextField T="string"
              Value="Item.Note"
              Placeholder="Optional note"
              Variant="Variant.Text"
              Lines="2"
              Immediate="true"
              ValueChanged="OnNoteChangedAsync" />

<MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1" Class="mt-1">
    <MudChip T="string" Color="@PriorityColor(Item.Priority)" Variant="Variant.Text" Size="Size.Small">@Item.Priority.ToString()</MudChip>
    <MudText Typo="Typo.caption">@($"Created {RelativeTime(Item.CreatedAt)}")</MudText>
    @if (Item.CompletedAt.HasValue)
    {
        <MudText Typo="Typo.caption">@($"Completed {RelativeTime(Item.CompletedAt.Value)}")</MudText>
    }
</MudStack>

</div>

@code {
    [Parameter, EditorRequired]
    public TaskFlow.Domain.Task Item { get; set; } = null!;

    [Parameter]
    public IReadOnlyList<DomainTaskStatus> BoardStatuses { get; set; } = [];

    [Parameter]
    public EventCallback OnToggleComplete { get; set; }

    [Parameter]
    public EventCallback OnToggleFocus { get; set; }

    [Parameter]
    public bool AllowImportant { get; set; } = true;

    [Parameter]
    public EventCallback OnToggleImportant { get; set; }

    [Parameter]
    public EventCallback<string> OnUpdateTitle { get; set; }

    [Parameter]
    public EventCallback<string> OnUpdateNote { get; set; }

    [Parameter]
    public EventCallback<TaskPriority> OnUpdatePriority { get; set; }

    [Parameter]
    public EventCallback<DomainTaskStatus> OnUpdateStatus { get; set; }

    [Parameter]
    public EventCallback OnToggleToday { get; set; }

    [Parameter]
    public EventCallback OnDuplicate { get; set; }

    [Parameter]
    public EventCallback OnDelete { get; set; }

    [Parameter]
    public EventCallback OnRequestMove { get; set; }

    [Parameter]
    public bool ShowDeleteAction { get; set; } = true;

    private bool isCompleted;
    private bool isFocused;
    private bool isImportant;
    private Guid? boundTaskId;

    protected override void OnParametersSet()
    {
        if (this.boundTaskId == this.Item.Id)
        {
            return;
        }

        this.boundTaskId = this.Item.Id;
        this.isCompleted = this.Item.IsCompleted;
        this.isFocused = this.Item.IsFocused;
        this.isImportant = this.Item.IsImportant;
    }

    private static Color PriorityColor(TaskPriority priority)
    {
        return priority switch
        {
            TaskPriority.High => Color.Error,
            TaskPriority.Medium => Color.Warning,
            _ => Color.Success,
        };
    }

    private static string RelativeTime(DateTime value)
    {
        var delta = DateTime.UtcNow - value;
        if (delta.TotalMinutes < 1)
        {
            return "just now";
        }

        if (delta.TotalHours < 1)
        {
            return $"{Math.Floor(delta.TotalMinutes)}m ago";
        }

        if (delta.TotalDays < 1)
        {
            return $"{Math.Floor(delta.TotalHours)}h ago";
        }

        return $"{Math.Floor(delta.TotalDays)}d ago";
    }

    private async System.Threading.Tasks.Task OnCompleteChangedAsync(bool _)
    {
        var previous = this.isCompleted;
        this.isCompleted = !this.isCompleted;
        await InvokeAsync(StateHasChanged);
        try
        {
            await this.OnToggleComplete.InvokeAsync();
        }
        catch
        {
            this.isCompleted = previous;
            await InvokeAsync(StateHasChanged);
            throw;
        }
    }

    private async System.Threading.Tasks.Task OnToggleFocusAsync(MouseEventArgs _)
    {
        var previous = this.isFocused;
        this.isFocused = !this.isFocused;
        await InvokeAsync(StateHasChanged);
        try
        {
            await this.OnToggleFocus.InvokeAsync();
        }
        catch
        {
            this.isFocused = previous;
            await InvokeAsync(StateHasChanged);
            throw;
        }
    }

    private async System.Threading.Tasks.Task OnToggleImportantAsync(MouseEventArgs _)
    {
        var previous = this.isImportant;
        this.isImportant = !this.isImportant;
        await InvokeAsync(StateHasChanged);
        try
        {
            await this.OnToggleImportant.InvokeAsync();
        }
        catch
        {
            this.isImportant = previous;
            await InvokeAsync(StateHasChanged);
            throw;
        }
    }

    private System.Threading.Tasks.Task OnTitleChangedAsync(string value)
    {
        return this.OnUpdateTitle.InvokeAsync(value);
    }

    private System.Threading.Tasks.Task OnNoteChangedAsync(string value)
    {
        return this.OnUpdateNote.InvokeAsync(value);
    }

    private System.Threading.Tasks.Task OnPriorityChangedAsync(TaskPriority value)
    {
        return this.OnUpdatePriority.InvokeAsync(value);
    }

    private System.Threading.Tasks.Task OnStatusChangedAsync(DomainTaskStatus value)
    {
        return this.OnUpdateStatus.InvokeAsync(value);
    }

    private System.Threading.Tasks.Task OnToggleTodayAsync(MouseEventArgs _)
    {
        return this.OnToggleToday.InvokeAsync();
    }

    private System.Threading.Tasks.Task OnDuplicateAsync(MouseEventArgs _)
    {
        return this.OnDuplicate.InvokeAsync();
    }

    private System.Threading.Tasks.Task OnMoveRequestedAsync(MouseEventArgs _)
    {
        return this.OnRequestMove.InvokeAsync();
    }

    private System.Threading.Tasks.Task OnDeleteAsync(MouseEventArgs _)
    {
        return this.OnDelete.InvokeAsync();
    }
}
