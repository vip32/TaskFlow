@page "/focus-timer"
@using Task = System.Threading.Tasks.Task
@using Microsoft.AspNetCore.Components.Sections
@implements IDisposable
@inject ISnackbar Snackbar
@inject IJSRuntime JsRuntime
@inject FocusTimerStateService TimerState

<PageTitle>Focus Timer</PageTitle>

<SectionContent SectionName="AppTopBarTitle">
    <MudStack Class="ml-2" Spacing="0">
        <MudText Typo="Typo.subtitle1">Focus Timer</MudText>
        <MudText Typo="Typo.caption">Single-task work session</MudText>
    </MudStack>
</SectionContent>

<MudContainer MaxWidth="MaxWidth.Small" Class="py-6">
    <MudCard Elevation="1">
        <MudCardContent>
            <MudStack Spacing="2">
                <MudText Typo="Typo.subtitle2">Session</MudText>
                <MudText Typo="Typo.h4">@this.TimerState.TimerRemaining.ToString(@"mm\:ss")</MudText>
                <MudSelect T="int" Value="this.TimerState.SelectedTimerMinutes" ValueChanged="OnTimerPresetChangedAsync" Label="Duration" Dense="true" Variant="Variant.Outlined">
                    <MudSelectItem Value="5">5 mins</MudSelectItem>
                    <MudSelectItem Value="15">15 mins</MudSelectItem>
                    <MudSelectItem Value="30">30 mins</MudSelectItem>
                    <MudSelectItem Value="60">60 mins</MudSelectItem>
                </MudSelect>
                <MudStack Row="true" Spacing="1">
                    <MudButton Variant="Variant.Filled" Color="Color.Success" OnClick="StartTimerAsync" Disabled="@this.TimerState.TimerRunning">Start</MudButton>
                    <MudButton Variant="Variant.Outlined" OnClick="PauseTimerAsync" Disabled="@(!this.TimerState.TimerRunning)">Pause</MudButton>
                    <MudButton Variant="Variant.Text" OnClick="ResetTimerAsync">Reset</MudButton>
                </MudStack>
            </MudStack>
        </MudCardContent>
    </MudCard>
</MudContainer>

@code {
    protected override void OnInitialized()
    {
        this.TimerState.Changed += OnTimerStateChanged;
        this.TimerState.Completed += OnTimerCompleted;
    }

    private Task OnTimerPresetChangedAsync(int minutes)
    {
        return this.TimerState.SetPresetAsync(minutes);
    }

    private async Task StartTimerAsync()
    {
        await PlayTimerBeepAsync("start");
        await this.TimerState.StartAsync();
    }

    private Task PauseTimerAsync()
    {
        return this.TimerState.PauseAsync();
    }

    private Task ResetTimerAsync()
    {
        return this.TimerState.ResetAsync();
    }

    private void OnTimerStateChanged()
    {
        _ = InvokeAsync(StateHasChanged);
    }

    private void OnTimerCompleted()
    {
        _ = InvokeAsync(async () =>
        {
            this.Snackbar.Add("Focus session complete.", Severity.Success);
            await PlayTimerBeepAsync("finish");
            StateHasChanged();
        });
    }

    private async Task PlayTimerBeepAsync(string eventType)
    {
        try
        {
            await this.JsRuntime.InvokeVoidAsync("taskflowAudio.beep", eventType);
        }
        catch
        {
        }
    }

    public void Dispose()
    {
        this.TimerState.Changed -= OnTimerStateChanged;
        this.TimerState.Completed -= OnTimerCompleted;
    }
}
