@using Task = System.Threading.Tasks.Task
@using TaskFlow.Domain
@using DomainTaskStatus = TaskFlow.Domain.TaskStatus

<MudDialog>
    <DialogContent>
        <TaskCard Item="Task"
                  BoardStatuses="BoardStatuses"
                  OnToggleComplete="() => OnToggleComplete.InvokeAsync(Task)"
                  OnToggleFocus="() => OnToggleFocus.InvokeAsync(Task)"
                  OnToggleImportant="() => OnToggleImportant.InvokeAsync(Task)"
                  OnUpdateTitle="value => OnUpdateTitle.InvokeAsync(new TaskStringChange(Task, value))"
                  OnUpdateNote="value => OnUpdateNote.InvokeAsync(new TaskStringChange(Task, value))"
                  OnUpdatePriority="value => OnUpdatePriority.InvokeAsync(new TaskPriorityChange(Task, value))"
                  OnUpdateStatus="value => OnUpdateStatus.InvokeAsync(new TaskStatusChange(Task, value))"
                  OnToggleToday="() => OnToggleToday.InvokeAsync(Task)"
                  OnDuplicate="() => OnDuplicate.InvokeAsync(Task)"
                  OnDelete="() => OnDelete.InvokeAsync(Task)"
                  ShowDeleteAction="false"
                  OnRequestMove="() => OnRequestMove.InvokeAsync(Task.Id)" />

        @if (SubTasks.Count > 0)
        {
            <MudStack Spacing="1" Class="mt-2">
                @foreach (var subTask in SubTasks)
                {
                    <MudPaper Elevation="0" Class="pa-2">
                        <TaskCard Item="subTask"
                                  BoardStatuses="BoardStatuses"
                                  AllowImportant="false"
                                  OnToggleComplete="() => OnToggleComplete.InvokeAsync(subTask)"
                                  OnToggleFocus="() => OnToggleFocus.InvokeAsync(subTask)"
                                  OnUpdateTitle="value => OnUpdateTitle.InvokeAsync(new TaskStringChange(subTask, value))"
                                  OnUpdateNote="value => OnUpdateNote.InvokeAsync(new TaskStringChange(subTask, value))"
                                  OnUpdatePriority="value => OnUpdatePriority.InvokeAsync(new TaskPriorityChange(subTask, value))"
                                  OnUpdateStatus="value => OnUpdateStatus.InvokeAsync(new TaskStatusChange(subTask, value))"
                                  OnToggleToday="() => OnToggleToday.InvokeAsync(subTask)"
                                  OnDuplicate="() => OnDuplicate.InvokeAsync(subTask)"
                                  OnDelete="() => OnDelete.InvokeAsync(subTask)"
                                  ShowDeleteAction="false"
                                  OnRequestMove="() => OnRequestMove.InvokeAsync(subTask.Id)" />
                    </MudPaper>
                }
            </MudStack>
        }

        <MudStack Row="true" Spacing="1" Class="mt-2">
            <MudTextField T="string"
                          @bind-Value="newSubTaskTitle"
                          Placeholder="Add subtask"
                          Variant="Variant.Outlined"
                          Margin="Margin.Dense"
                          TextUpdateSuppression="false"
                          OnKeyUp="HandleCreateSubTaskKeyUp" />
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="CreateSubTaskAsync">Add</MudButton>
        </MudStack>
    </DialogContent>
    <DialogActions>
        @if (showDeleteConfirmation)
        {
            <MudText Typo="Typo.body2" Color="Color.Error">Delete this task?</MudText>
            <MudButton Variant="Variant.Outlined" Color="Color.Default" OnClick="CancelDeleteConfirmation">Cancel</MudButton>
            <MudButton Variant="Variant.Filled" Color="Color.Error" OnClick="DeleteTaskAndCloseAsync">Delete</MudButton>
        }
        else
        {
            <MudTooltip Text="Delete task">
                <MudIconButton Icon="@Icons.Material.Filled.Delete"
                               Color="Color.Error"
                               aria-label="Delete task"
                               title="Delete task"
                               OnClick="ShowDeleteConfirmation" />
            </MudTooltip>
        }
        <MudSpacer />
        <MudButton Variant="Variant.Outlined" OnClick="CancelDialog">Cancel</MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="OkDialog">OK</MudButton>
    </DialogActions>
</MudDialog>

@code {
    public sealed record TaskStringChange(TaskFlow.Domain.Task Task, string Value);

    public sealed record TaskPriorityChange(TaskFlow.Domain.Task Task, TaskPriority Value);

    public sealed record TaskStatusChange(TaskFlow.Domain.Task Task, DomainTaskStatus Value);

    [Parameter, EditorRequired]
    public TaskFlow.Domain.Task Task { get; set; } = null!;

    [Parameter]
    public IReadOnlyList<TaskFlow.Domain.Task> SubTasks { get; set; } = [];

    [Parameter, EditorRequired]
    public IReadOnlyList<DomainTaskStatus> BoardStatuses { get; set; } = [];

    [Parameter, EditorRequired]
    public EventCallback<TaskFlow.Domain.Task> OnToggleComplete { get; set; }

    [Parameter, EditorRequired]
    public EventCallback<TaskFlow.Domain.Task> OnToggleFocus { get; set; }

    [Parameter, EditorRequired]
    public EventCallback<TaskFlow.Domain.Task> OnToggleImportant { get; set; }

    [Parameter, EditorRequired]
    public EventCallback<TaskStringChange> OnUpdateTitle { get; set; }

    [Parameter, EditorRequired]
    public EventCallback<TaskStringChange> OnUpdateNote { get; set; }

    [Parameter, EditorRequired]
    public EventCallback<TaskPriorityChange> OnUpdatePriority { get; set; }

    [Parameter, EditorRequired]
    public EventCallback<TaskStatusChange> OnUpdateStatus { get; set; }

    [Parameter, EditorRequired]
    public EventCallback<TaskFlow.Domain.Task> OnToggleToday { get; set; }

    [Parameter, EditorRequired]
    public EventCallback<TaskFlow.Domain.Task> OnDuplicate { get; set; }

    [Parameter, EditorRequired]
    public EventCallback<TaskFlow.Domain.Task> OnDelete { get; set; }

    [Parameter, EditorRequired]
    public EventCallback<Guid> OnRequestMove { get; set; }

    [Parameter, EditorRequired]
    public EventCallback<string> OnCreateSubTask { get; set; }

    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; } = null!;

    private string newSubTaskTitle = string.Empty;
    private bool showDeleteConfirmation;

    protected override void OnParametersSet()
    {
        this.showDeleteConfirmation = false;
    }

    private void OkDialog()
    {
        this.MudDialog.Close(DialogResult.Ok(true));
    }

    private void CancelDialog()
    {
        this.MudDialog.Cancel();
    }

    private async Task DeleteTaskAndCloseAsync()
    {
        await this.OnDelete.InvokeAsync(this.Task);
        this.MudDialog.Close(DialogResult.Ok(true));
    }

    private void ShowDeleteConfirmation()
    {
        this.showDeleteConfirmation = true;
    }

    private void CancelDeleteConfirmation()
    {
        this.showDeleteConfirmation = false;
    }

    private async Task CreateSubTaskAsync()
    {
        var title = this.newSubTaskTitle?.Trim() ?? string.Empty;
        if (string.IsNullOrWhiteSpace(title))
        {
            return;
        }

        await this.OnCreateSubTask.InvokeAsync(title);
        this.newSubTaskTitle = string.Empty;
    }

    private async Task HandleCreateSubTaskKeyUp(KeyboardEventArgs args)
    {
        if (args.Key == "Enter" || args.Key == "NumpadEnter")
        {
            await CreateSubTaskAsync();
        }
    }
}
