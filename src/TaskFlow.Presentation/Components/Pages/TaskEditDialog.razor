@using Task = System.Threading.Tasks.Task
@using TaskFlow.Domain
@using DomainTaskStatus = TaskFlow.Domain.TaskStatus

<div class="tf-shortcuts-backdrop" tabindex="0" @onclick="HandleCloseAsync" @onkeydown="HandleKeyDownAsync">
    <MudPaper Class="tf-shortcuts-dialog" @onclick:stopPropagation="true">
        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-2">
            <MudText Typo="Typo.h6">Edit Task</MudText>
            <MudIconButton Icon="@Icons.Material.Filled.Close" aria-label="Close dialog" title="Close dialog" OnClick="HandleCloseAsync" />
        </MudStack>

        <TaskCard Item="Task"
                  BoardStatuses="BoardStatuses"
                  OnToggleComplete="() => OnToggleComplete.Invoke(Task)"
                  OnToggleFocus="() => OnToggleFocus.Invoke(Task)"
                  OnToggleImportant="() => OnToggleImportant.Invoke(Task)"
                  OnUpdateTitle="value => OnUpdateTitle.Invoke(Task, value)"
                  OnUpdateNote="value => OnUpdateNote.Invoke(Task, value)"
                  OnUpdatePriority="value => OnUpdatePriority.Invoke(Task, value)"
                  OnUpdateStatus="value => OnUpdateStatus.Invoke(Task, value)"
                  OnToggleToday="() => OnToggleToday.Invoke(Task)"
                  OnDuplicate="() => OnDuplicate.Invoke(Task)"
                  OnDelete="() => OnDelete.Invoke(Task)"
                  OnRequestMove="() => OnRequestMove.Invoke(Task.Id)" />

        @if (SubTasks.Count > 0)
        {
            <div class="tf-subtasks mt-2">
                @foreach (var subTask in SubTasks)
                {
                    <MudPaper Class="tf-subtask" Elevation="0">
                        <TaskCard Item="subTask"
                                  BoardStatuses="BoardStatuses"
                                  AllowImportant="false"
                                  OnToggleComplete="() => OnToggleComplete.Invoke(subTask)"
                                  OnToggleFocus="() => OnToggleFocus.Invoke(subTask)"
                                  OnUpdateTitle="value => OnUpdateTitle.Invoke(subTask, value)"
                                  OnUpdateNote="value => OnUpdateNote.Invoke(subTask, value)"
                                  OnUpdatePriority="value => OnUpdatePriority.Invoke(subTask, value)"
                                  OnUpdateStatus="value => OnUpdateStatus.Invoke(subTask, value)"
                                  OnToggleToday="() => OnToggleToday.Invoke(subTask)"
                                  OnDuplicate="() => OnDuplicate.Invoke(subTask)"
                                  OnDelete="() => OnDelete.Invoke(subTask)"
                                  OnRequestMove="() => OnRequestMove.Invoke(subTask.Id)" />
                    </MudPaper>
                }
            </div>
        }

        <MudStack Row="true" Spacing="1" Class="mt-2">
            <MudTextField T="string"
                          Value="NewSubTaskTitle"
                          ValueChanged="OnNewSubTaskTitleChanged"
                          Placeholder="Add subtask"
                          Variant="Variant.Outlined"
                          Margin="Margin.Dense"
                          TextUpdateSuppression="false"
                          OnKeyUp="HandleCreateSubTaskKeyUp" />
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="OnCreateSubTask">Add</MudButton>
        </MudStack>
    </MudPaper>
</div>

@code {
    [Parameter, EditorRequired]
    public TaskFlow.Domain.Task Task { get; set; } = null!;

    [Parameter]
    public IReadOnlyList<TaskFlow.Domain.Task> SubTasks { get; set; } = [];

    [Parameter, EditorRequired]
    public IReadOnlyList<DomainTaskStatus> BoardStatuses { get; set; } = [];

    [Parameter, EditorRequired]
    public Func<TaskFlow.Domain.Task, Task> OnToggleComplete { get; set; } = null!;

    [Parameter, EditorRequired]
    public Func<TaskFlow.Domain.Task, Task> OnToggleFocus { get; set; } = null!;

    [Parameter, EditorRequired]
    public Func<TaskFlow.Domain.Task, Task> OnToggleImportant { get; set; } = null!;

    [Parameter, EditorRequired]
    public Func<TaskFlow.Domain.Task, string, Task> OnUpdateTitle { get; set; } = null!;

    [Parameter, EditorRequired]
    public Func<TaskFlow.Domain.Task, string, Task> OnUpdateNote { get; set; } = null!;

    [Parameter, EditorRequired]
    public Func<TaskFlow.Domain.Task, TaskPriority, Task> OnUpdatePriority { get; set; } = null!;

    [Parameter, EditorRequired]
    public Func<TaskFlow.Domain.Task, DomainTaskStatus, Task> OnUpdateStatus { get; set; } = null!;

    [Parameter, EditorRequired]
    public Func<TaskFlow.Domain.Task, Task> OnToggleToday { get; set; } = null!;

    [Parameter, EditorRequired]
    public Func<TaskFlow.Domain.Task, Task> OnDuplicate { get; set; } = null!;

    [Parameter, EditorRequired]
    public Func<TaskFlow.Domain.Task, Task> OnDelete { get; set; } = null!;

    [Parameter, EditorRequired]
    public Action<Guid> OnRequestMove { get; set; } = null!;

    [Parameter]
    public string NewSubTaskTitle { get; set; } = string.Empty;

    [Parameter, EditorRequired]
    public EventCallback<string> OnNewSubTaskTitleChanged { get; set; }

    [Parameter, EditorRequired]
    public Func<Task> OnCreateSubTask { get; set; } = null!;

    [Parameter, EditorRequired]
    public EventCallback OnClose { get; set; }

    private Task HandleCloseAsync()
    {
        return this.OnClose.InvokeAsync();
    }

    private Task HandleKeyDownAsync(KeyboardEventArgs args)
    {
        return args.Key == "Escape"
            ? HandleCloseAsync()
            : System.Threading.Tasks.Task.CompletedTask;
    }

    private async Task HandleCreateSubTaskKeyUp(KeyboardEventArgs args)
    {
        if (args.Key == "Enter" || args.Key == "NumpadEnter")
        {
            await this.OnCreateSubTask.Invoke();
        }
    }
}
