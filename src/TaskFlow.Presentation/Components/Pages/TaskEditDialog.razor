@using Task = System.Threading.Tasks.Task
@using TaskFlow.Domain
@using DomainTaskStatus = TaskFlow.Domain.TaskStatus

<div class="tf-shortcuts-backdrop" tabindex="0" @onclick="HandleCloseAsync" @onkeydown="HandleKeyDownAsync">
    <MudPaper Class="tf-shortcuts-dialog" @onclick:stopPropagation="true">
        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-2">
            <MudText Typo="Typo.h6">Edit Task</MudText>
            <MudIconButton Icon="@Icons.Material.Filled.Close" aria-label="Close dialog" title="Close dialog" OnClick="HandleCloseAsync" />
        </MudStack>

        <TaskCard Item="Task"
                  BoardStatuses="BoardStatuses"
                  OnToggleComplete="() => OnToggleComplete.InvokeAsync(Task)"
                  OnToggleFocus="() => OnToggleFocus.InvokeAsync(Task)"
                  OnToggleImportant="() => OnToggleImportant.InvokeAsync(Task)"
                  OnUpdateTitle="value => OnUpdateTitle.InvokeAsync(new TaskStringChange(Task, value))"
                  OnUpdateNote="value => OnUpdateNote.InvokeAsync(new TaskStringChange(Task, value))"
                  OnUpdatePriority="value => OnUpdatePriority.InvokeAsync(new TaskPriorityChange(Task, value))"
                  OnUpdateStatus="value => OnUpdateStatus.InvokeAsync(new TaskStatusChange(Task, value))"
                  OnToggleToday="() => OnToggleToday.InvokeAsync(Task)"
                  OnDuplicate="() => OnDuplicate.InvokeAsync(Task)"
                  OnDelete="() => OnDelete.InvokeAsync(Task)"
                  OnRequestMove="() => OnRequestMove.InvokeAsync(Task.Id)" />

        @if (SubTasks.Count > 0)
        {
            <div class="tf-subtasks mt-2">
                @foreach (var subTask in SubTasks)
                {
                    <MudPaper Class="tf-subtask" Elevation="0">
                        <TaskCard Item="subTask"
                                  BoardStatuses="BoardStatuses"
                                  AllowImportant="false"
                                  OnToggleComplete="() => OnToggleComplete.InvokeAsync(subTask)"
                                  OnToggleFocus="() => OnToggleFocus.InvokeAsync(subTask)"
                                  OnUpdateTitle="value => OnUpdateTitle.InvokeAsync(new TaskStringChange(subTask, value))"
                                  OnUpdateNote="value => OnUpdateNote.InvokeAsync(new TaskStringChange(subTask, value))"
                                  OnUpdatePriority="value => OnUpdatePriority.InvokeAsync(new TaskPriorityChange(subTask, value))"
                                  OnUpdateStatus="value => OnUpdateStatus.InvokeAsync(new TaskStatusChange(subTask, value))"
                                  OnToggleToday="() => OnToggleToday.InvokeAsync(subTask)"
                                  OnDuplicate="() => OnDuplicate.InvokeAsync(subTask)"
                                  OnDelete="() => OnDelete.InvokeAsync(subTask)"
                                  OnRequestMove="() => OnRequestMove.InvokeAsync(subTask.Id)" />
                    </MudPaper>
                }
            </div>
        }

        <MudStack Row="true" Spacing="1" Class="mt-2">
            <MudTextField T="string"
                          Value="NewSubTaskTitle"
                          ValueChanged="OnNewSubTaskTitleChanged"
                          Placeholder="Add subtask"
                          Variant="Variant.Outlined"
                          Margin="Margin.Dense"
                          TextUpdateSuppression="false"
                          OnKeyUp="HandleCreateSubTaskKeyUp" />
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="() => OnCreateSubTask.InvokeAsync()">Add</MudButton>
        </MudStack>
    </MudPaper>
</div>

@code {
    public sealed record TaskStringChange(TaskFlow.Domain.Task Task, string Value);

    public sealed record TaskPriorityChange(TaskFlow.Domain.Task Task, TaskPriority Value);

    public sealed record TaskStatusChange(TaskFlow.Domain.Task Task, DomainTaskStatus Value);

    [Parameter, EditorRequired]
    public TaskFlow.Domain.Task Task { get; set; } = null!;

    [Parameter]
    public IReadOnlyList<TaskFlow.Domain.Task> SubTasks { get; set; } = [];

    [Parameter, EditorRequired]
    public IReadOnlyList<DomainTaskStatus> BoardStatuses { get; set; } = [];

    [Parameter, EditorRequired]
    public EventCallback<TaskFlow.Domain.Task> OnToggleComplete { get; set; }

    [Parameter, EditorRequired]
    public EventCallback<TaskFlow.Domain.Task> OnToggleFocus { get; set; }

    [Parameter, EditorRequired]
    public EventCallback<TaskFlow.Domain.Task> OnToggleImportant { get; set; }

    [Parameter, EditorRequired]
    public EventCallback<TaskStringChange> OnUpdateTitle { get; set; }

    [Parameter, EditorRequired]
    public EventCallback<TaskStringChange> OnUpdateNote { get; set; }

    [Parameter, EditorRequired]
    public EventCallback<TaskPriorityChange> OnUpdatePriority { get; set; }

    [Parameter, EditorRequired]
    public EventCallback<TaskStatusChange> OnUpdateStatus { get; set; }

    [Parameter, EditorRequired]
    public EventCallback<TaskFlow.Domain.Task> OnToggleToday { get; set; }

    [Parameter, EditorRequired]
    public EventCallback<TaskFlow.Domain.Task> OnDuplicate { get; set; }

    [Parameter, EditorRequired]
    public EventCallback<TaskFlow.Domain.Task> OnDelete { get; set; }

    [Parameter, EditorRequired]
    public EventCallback<Guid> OnRequestMove { get; set; }

    [Parameter]
    public string NewSubTaskTitle { get; set; } = string.Empty;

    [Parameter, EditorRequired]
    public EventCallback<string> OnNewSubTaskTitleChanged { get; set; }

    [Parameter, EditorRequired]
    public EventCallback OnCreateSubTask { get; set; }

    [Parameter, EditorRequired]
    public EventCallback OnClose { get; set; }

    private Task HandleCloseAsync()
    {
        return this.OnClose.InvokeAsync();
    }

    private Task HandleKeyDownAsync(KeyboardEventArgs args)
    {
        return args.Key == "Escape"
            ? HandleCloseAsync()
            : System.Threading.Tasks.Task.CompletedTask;
    }

    private async Task HandleCreateSubTaskKeyUp(KeyboardEventArgs args)
    {
        if (args.Key == "Enter" || args.Key == "NumpadEnter")
        {
            await this.OnCreateSubTask.InvokeAsync();
        }
    }
}
