@using TaskFlow.Domain
@using DomainTaskStatus = TaskFlow.Domain.TaskStatus

<MudDropContainer T="TaskFlow.Domain.Task"
                  @key="BoardRenderKey"
                  Items="BoardItems"
                  ItemsSelector="ItemInDropZone"
                  ItemDropped="HandleItemDropped"
                  Class="d-flex flex-wrap flex-grow-1">
    <ChildContent>
        @foreach (var status in BoardStatuses)
        {
            var boardTasks = GetBoardTasks.Invoke(status);
            <MudPaper Elevation="0" Class="pa-4 ma-2 d-flex flex-column flex-grow-1" MinHeight="340px" Style="min-width:260px;">
                <MudText Typo="Typo.subtitle1" Class="mb-2"><b>@status</b> (@boardTasks.Count)</MudText>
                <MudDropZone T="TaskFlow.Domain.Task" Identifier="@status.ToString()" Class="flex-grow-1" />
                @if (boardTasks.Count == 0)
                {
                    <MudText Typo="Typo.caption" Class="mt-2">Drop tasks here</MudText>
                }

                <MudStack Row="true" Spacing="1" Class="mt-2">
                    <MudTextField T="string"
                                  Value="@GetNewTaskTitle(status)"
                                  ValueChanged="value => SetNewTaskTitle(status, value)"
                                  Placeholder="Add task"
                                  Variant="Variant.Outlined"
                                  Margin="Margin.Dense"
                                  TextUpdateSuppression="false"
                                  OnKeyUp="args => HandleCreateTaskKeyUp(status, args)" />
                    <MudIconButton Icon="@Icons.Material.Filled.Add" Color="Color.Primary" aria-label="Add task" title="Add task" OnClick="() => CreateTaskInStatusAsync(status)" />
                </MudStack>
            </MudPaper>
        }
    </ChildContent>
    <ItemRenderer>
        <MudPaper Elevation="2" Class="pa-3 ma-2">
            <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Spacing="1">
                <MudText Typo="Typo.body1">@context.Title</MudText>
                <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Primary" Size="Size.Small" aria-label="Edit task" title="Edit task" OnClick="() => OnEditTaskRequested.InvokeAsync(context.Id)" />
            </MudStack>
        </MudPaper>
    </ItemRenderer>
</MudDropContainer>

@code {
    [Parameter, EditorRequired]
    public IReadOnlyList<DomainTaskStatus> BoardStatuses { get; set; } = [];

    [Parameter, EditorRequired]
    public Func<DomainTaskStatus, List<TaskFlow.Domain.Task>> GetBoardTasks { get; set; } = null!;

    [Parameter, EditorRequired]
    public EventCallback<BoardDropRequest> OnDropTaskToStatus { get; set; }

    [Parameter, EditorRequired]
    public EventCallback<BoardCreateRequest> OnCreateTaskInStatus { get; set; }

    [Parameter, EditorRequired]
    public EventCallback<Guid> OnEditTaskRequested { get; set; }

    private readonly Dictionary<DomainTaskStatus, string> newTaskTitles = [];

    public sealed record BoardDropRequest(TaskFlow.Domain.Task Task, DomainTaskStatus Status);
    public sealed record BoardCreateRequest(DomainTaskStatus Status, string Title);

    private List<TaskFlow.Domain.Task> BoardItems => this.BoardStatuses
        .SelectMany(status => this.GetBoardTasks.Invoke(status))
        .Where(task => !task.ParentTaskId.HasValue)
        .GroupBy(task => task.Id)
        .Select(group => group.First())
        .ToList();

    private string BoardRenderKey => string.Join('|', this.BoardItems.Select(item => $"{item.Id:N}:{item.Status}"));

    private bool ItemInDropZone(TaskFlow.Domain.Task item, string dropZoneIdentifier)
    {
        return Enum.TryParse<DomainTaskStatus>(dropZoneIdentifier, out var status)
            && item.Status == status;
    }

    private async System.Threading.Tasks.Task HandleItemDropped(MudItemDropInfo<TaskFlow.Domain.Task> drop)
    {
        if (!Enum.TryParse<DomainTaskStatus>(drop.DropzoneIdentifier, out var status))
        {
            return;
        }

        if (drop.Item.Status == status)
        {
            return;
        }

        await this.OnDropTaskToStatus.InvokeAsync(new BoardDropRequest(drop.Item, status));
    }

    private string GetNewTaskTitle(DomainTaskStatus status)
    {
        return this.newTaskTitles.TryGetValue(status, out var value) ? value : string.Empty;
    }

    private void SetNewTaskTitle(DomainTaskStatus status, string value)
    {
        this.newTaskTitles[status] = value;
    }

    private async System.Threading.Tasks.Task HandleCreateTaskKeyUp(DomainTaskStatus status, KeyboardEventArgs args)
    {
        if (args.Key == "Enter" || args.Key == "NumpadEnter")
        {
            await CreateTaskInStatusAsync(status);
        }
    }

    private async System.Threading.Tasks.Task CreateTaskInStatusAsync(DomainTaskStatus status)
    {
        var title = GetNewTaskTitle(status);
        if (string.IsNullOrWhiteSpace(title))
        {
            return;
        }

        this.newTaskTitles[status] = string.Empty;
        await this.OnCreateTaskInStatus.InvokeAsync(new BoardCreateRequest(status, title));
    }
}
